#!/usr/bin/env python
# Copyright (C) 2013 - 2018 Malshare Developers.
# Written by Silas Cutler
# Quick search tool for  MalShare API

import sys
import json
import requests
import time

api_key = "84edbc35fe7d3c408099e9b1955ed65122e4542af65797d93d6d4799f6098fcf"
if api_key != "":
	url="https://malshare.com/api.php?api_key=%s&action=type&type=%s"% (api_key, sys.argv[1] )
	print(url)
	r = requests.get(url)

	#Strore al hashes on a json file
	json_data = json.dumps(r.json(), sort_keys=True, indent=4, separators=(',', ': '))

	#Cont how many hashes?
	item_dict = json.loads(json_data)
	samples_count = len(item_dict)

	#Print Samples_Count
	print "\n**********\nSamples Count = ",samples_count,"\n**********\n"
	
	#Print in a well organized JSON format
	print "\n********** Organized JSON\n",json_data,"\n**********\n"
	
	#Print in A Raw JSON Format
	print "\n********** RAW JSON\n",item_dict,"\n**********\n"

	#Save OutPut in a JSON Format
	print "********** SAVE Data Into File"
        datetime = time.strftime("%Y-%m-%d")
        filename = "malshare"+datetime+".json"

	print "Save Into File "+filename
	with open(filename,'w') as outfile:
		json.dump(item_dict, outfile)
	print "DONE"
	print "**********"



else:
	print "Please set API key"

for i in range(0, samples_count):
	sha256= item_dict[i]['sha256']
	url="https://malshare.com/api.php?api_key=%s&action=getfile&hash=%s"%(api_key, sha256)
	print url
	r = request.get(url)
	open(i+datetime+'.elf','wb').write(r.content)

